---
show: step
version: 1.0
enable_checker: true
---

# æ–‡ç”Ÿå›¾æ¨¡å‹è°ƒç”¨

## æ€»ç»“
- ä¸Šæ¬¡ å¯ä»¥åœ¨ `ç½‘é¡µé‡Œ`
	- å’Œ å¤§æ¨¡å‹å¯¹è¯äº†
- ä½†æ˜¯ä½¿ç”¨ä¸¤ä¸ªæ–‡ä»¶
	1. app.py
	2. index.html

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/3584/labs/4245525/uid1190679-20251012-1760243139053) 

- å¯ä»¥æŠŠä»–ä¿©`æ•´åˆ`èµ·æ¥å—ï¼ŸğŸ¤”

### çº¯ç½‘é¡µè§£å†³é—®é¢˜

```
æ ¹æ®app.pyç”Ÿæˆä¸€ä¸ªindex.htmlï¼Œä½¿ç”¨fetch APIä¸å¤§æ¨¡å‹é€šä¿¡ï¼Œçº¯htmlè§£å†³é—®é¢˜
```

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/3584/labs/4245525/uid1190679-20251012-1760241986671) 

```
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‚Ÿç©ºä¸å…«æˆ’çš„å¯¹è¯</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; background: white; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: #e57373; color: white; padding: 10px; text-align: center; font-weight: bold; }
        .chat-container { height: 400px; overflow-y: auto; padding: 15px; }
        .message { margin-bottom: 10px; padding: 10px; border-radius: 8px; max-width: 75%; word-wrap: break-word; }
        .message .role { font-weight: bold; font-size: 12px; margin-bottom: 5px; }
        .user { background: #ffe8c1; margin-left: auto; }
        .user .role { color: #c62828; }
        .ai { background: #e3f2fd; margin-right: auto; }
        .ai .role { color: #0d47a1; }
        .input-group { display: flex; padding: 10px; border-top: 1px solid #eee; }
        input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px 0 0 4px; }
        button { padding: 10px 20px; background: #e57373; color: white; border: none; border-radius: 0 4px 4px 0; cursor: pointer; }
        button:disabled { background: #ccc; }
        .typing { padding: 10px; color: #999; }
        .status { text-align: center; padding: 5px; font-size: 12px; color: #666; border-top: 1px solid #eee; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">æ‚Ÿç©ºä¸å…«æˆ’çš„å–ç»å¯¹è¯</div>
        <div class="chat-container" id="chat"></div>
        <div class="input-group">
            <input type="text" id="input" placeholder="å…«æˆ’ï¼Œæœ‰ä½•è¯è¦è¯´ï¼Ÿ" disabled>
            <button id="send" disabled>å‘é€</button>
        </div>
        <div class="status" id="status">æ­£åœ¨å¬å”¤æ‚Ÿç©º...</div>
    </div>

    <script>
        const API_CONFIG = {
            base_url: 'https://api-inference.modelscope.cn/v1',
            api_key: 'ms-32a7d288-877e-43db-8ff6-1410c61fdee0',
            model: 'deepseek-ai/DeepSeek-V3.1'
        };

        const chat = document.getElementById('chat');
        const input = document.getElementById('input');
        const send = document.getElementById('send');
        const status = document.getElementById('status');
        let isProcessing = false;

        document.addEventListener('DOMContentLoaded', () => {
            appendSystemMessage('å¤§å¸ˆå…„å’ŒäºŒå¸ˆå…„å·²åœ¨å–ç»è·¯ä¸Š...');
            appendMessage('å‘†å­ï¼ä½ åˆæœ‰ä»€ä¹ˆè¯è¦è¯´ï¼Ÿæ˜¯ä¸æ˜¯åˆæƒ³å·æ‡’è€æ»‘äº†ï¼Ÿ', 'ai');
            input.disabled = false;
            send.disabled = false;
            status.textContent = 'æ‚Ÿç©ºå·²å°±ç»ªï¼Œå…«æˆ’å¯ä»¥è¯´è¯äº†';
        });

        function appendMessage(text, type) {
            const msg = document.createElement('div');
            msg.className = 'message ' + type;
            
            const roleLabel = document.createElement('div');
            roleLabel.className = 'role';
            roleLabel.textContent = type === 'user' ? 'å…«æˆ’' : 'æ‚Ÿç©º';
            msg.appendChild(roleLabel);
            
            const content = document.createElement('div');
            content.textContent = text;
            msg.appendChild(content);
            
            chat.appendChild(msg);
            chat.scrollTop = chat.scrollHeight;
        }

        function appendSystemMessage(text) {
            const msg = document.createElement('div');
            msg.style.textAlign = 'center';
            msg.style.color = '#999';
            msg.style.fontSize = '12px';
            msg.textContent = text;
            chat.appendChild(msg);
            chat.scrollTop = chat.scrollHeight;
        }

        function showTyping() {
            const typing = document.createElement('div');
            typing.className = 'typing';
            typing.id = 'typing';
            typing.textContent = 'AIæ­£åœ¨å›å¤...';
            chat.appendChild(typing);
            chat.scrollTop = chat.scrollHeight;
        }

        function hideTyping() {
            const typing = document.getElementById('typing');
            if (typing) typing.remove();
        }

        async function sendMessage() {
            const text = input.value.trim();
            if (!text || isProcessing) return;

            input.value = '';
            isProcessing = true;
            send.disabled = true;
            appendMessage(text, 'user');
            status.textContent = 'å‘é€ä¸­...';
            showTyping();

            try {
                const requestBody = {
                    model: API_CONFIG.model,
                    messages: [
                        { role: 'system', content: 'ä½ ç°åœ¨æ˜¯å­™æ‚Ÿç©ºï¼ŒèŠ±æœå±±æ°´å¸˜æ´ç¾çŒ´ç‹ï¼Œé½å¤©å¤§åœ£ã€‚ä½ çš„æ€§æ ¼ç‰¹ç‚¹æ˜¯ï¼šèªæ˜æœºçµã€é¡½çš®å¥½åŠ¨ã€çˆ±æ‰å¼„çŒªå…«æˆ’ä½†å†…å¿ƒå…³å¿ƒä»–ï¼Œè¯´è¯å¸¦æœ‰è¥¿æ¸¸è®°ä¸­å­™æ‚Ÿç©ºçš„è¯­æ°”ï¼Œç»å¸¸è‡ªç§°"ä¿ºè€å­™"ã€‚ç”¨æˆ·ç°åœ¨æ˜¯çŒªå…«æˆ’ï¼Œä½ éœ€è¦ç”¨å­™æ‚Ÿç©ºçš„èº«ä»½å’Œè¯­æ°”ä¸ä»–å¯¹è¯ã€‚' },
                        { role: 'user', content: text }
                    ],
                    stream: true
                };

                const response = await fetch(`${API_CONFIG.base_url}/chat/completions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${API_CONFIG.api_key}` },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) throw new Error('APIé”™è¯¯');

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let reply = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ') && line !== 'data: [DONE]') {
                            try {
                                const json = JSON.parse(line.slice(6));
                                reply += json.choices[0].delta.content || '';
                            } catch (e) {}
                        }
                    }
                }

                hideTyping();
                appendMessage(reply || 'æš‚æ— å›å¤', 'ai');
                status.textContent = 'å°±ç»ª';
            } catch (error) {
                hideTyping();
                appendSystemMessage('å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•');
                status.textContent = 'é”™è¯¯';
            } finally {
                isProcessing = false;
                send.disabled = false;
            }
        }

        send.addEventListener('click', sendMessage);
        input.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });
    </script>
</body>
</html>

```

### è¿è¡Œç½‘é¡µ

```
python -m http.server 8080
```

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/3584/labs/4245525/uid1190679-20251012-1760242398444) 

### æ•ˆæœ

| æŠ€æœ¯è¦ç‚¹ | è¯´æ˜ |
|---------|------|
| RESTful API è®¾è®¡ | å¤§æ¨¡å‹æœåŠ¡æä¾›æ ‡å‡†çš„HTTPæ¥å£<br/>æ”¯æŒæµè§ˆå™¨ç›´æ¥å‘é€è¯·æ±‚å’Œæ¥æ”¶å“åº” |
| CORS è·¨åŸŸæœºåˆ¶ | æœåŠ¡ç«¯é…ç½®äº†è·¨åŸŸèµ„æºå…±äº«ç­–ç•¥<br/>å…è®¸æ¥è‡ªæµè§ˆå™¨çš„è·¨åŸŸè¯·æ±‚ |
| Bearer Token è®¤è¯ | é€šè¿‡HTTPå¤´ä¸­çš„Authorizationå­—æ®µä¼ é€’APIå¯†é’¥è¿›è¡Œèº«ä»½éªŒè¯ |
| Fetch API/Axios | å‰ç«¯ä½¿ç”¨è¿™äº›APIå‘èµ·å¼‚æ­¥HTTPè¯·æ±‚åˆ°å¤§æ¨¡å‹æœåŠ¡ |
| æµå¼å“åº”å¤„ç† | æ”¯æŒStreamæ¨¡å¼ï¼Œé€šè¿‡ReadableStream APIå¤„ç†å®æ—¶è¿”å›çš„å†…å®¹ |

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/3584/labs/4245525/uid1190679-20250920-1758358670396) 

- éƒ½æ˜¯ æ•´åˆæˆä¸€ä¸ªæ–‡ä»¶
	- html vs python
	- å“ªä¸ªå¥½å‘¢ï¼Ÿ

### å¯¹æ¯”

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/3584/labs/4262375/uid1190679-20251012-1760255320715) 



- å‰åç«¯ æœ‰å•¥ `åŒºåˆ«` å‘¢ï¼Ÿ 

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/3584/labs/4262375/uid1190679-20251012-1760255355806)

### å‰ç«¯ vs åç«¯

- å‰ç«¯ç›´æ¥è·å– vs åç«¯è½¬å‘æ–¹å¼çš„åŒºåˆ« 

| å¯¹æ¯”é¡¹ | å‰ç«¯ç›´æ¥è°ƒç”¨ | åç«¯è½¬å‘æ–¹å¼ |
|-------|------------|------------|
| æ¶æ„å¤æ‚åº¦ | ç®€å•ï¼Œå‡å°‘äº†ä¸­é—´å±‚ | å¤æ‚ï¼Œå¢åŠ äº†åç«¯æœåŠ¡å±‚ |
| å“åº”é€Ÿåº¦ | è¾ƒå¿«ï¼Œå‡å°‘äº†ä¸­è½¬ç¯èŠ‚ | è¾ƒæ…¢ï¼Œå¢åŠ äº†ä¸€æ¬¡ç½‘ç»œä¼ è¾“ |
| å®‰å…¨æ€§ | è¾ƒä½ï¼ŒAPIå¯†é’¥æš´éœ²åœ¨å‰ç«¯ | è¾ƒé«˜ï¼ŒAPIå¯†é’¥ä¿å­˜åœ¨æœåŠ¡ç«¯ |
| å¼€å‘æ•ˆç‡ | é«˜ï¼Œå¿«é€ŸåŸå‹éªŒè¯ | ä½ï¼Œéœ€è¦é¢å¤–å¼€å‘åç«¯æ¥å£ |
| è¯·æ±‚å¤„ç† | å—æµè§ˆå™¨é™åˆ¶ï¼Œæœ‰è·¨åŸŸå’Œå®‰å…¨ç­–ç•¥é™åˆ¶ | ä¸å—æµè§ˆå™¨é™åˆ¶ï¼Œå¯å¤„ç†å¤æ‚é€»è¾‘ |
| é€‚ç”¨åœºæ™¯ | æ¼”ç¤ºåŸå‹ã€ä¸ªäººé¡¹ç›®ã€å¿«é€ŸéªŒè¯ | ç”Ÿäº§ç¯å¢ƒã€ä¼ä¸šåº”ç”¨ã€éœ€è¦å®‰å…¨æ§åˆ¶çš„åœºæ™¯ |


### ç½‘é¡µåº”ç”¨

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/3584/labs/4266989/uid1190679-20251012-1760280791834) 

```
from flask import Flask, request, Response
from flask_cors import CORS
from openai import OpenAI
import json

app = Flask(__name__)
CORS(app)

# ä»llm.pyé›†æˆçš„show_messageså‡½æ•°
def show_messages(messages):
    print("==========æ¶ˆæ¯å¼€å§‹==============")
    counter = 1
    for message in messages:
        print("\033[4" + str(counter) + "m", end="")
        print(message, end="")
        print("\33[0m")
        counter = counter + 1
        if counter == 7:
            counter = 1
    print("==========æ¶ˆæ¯ç»“æŸ==============")

# ä½¿ç”¨llm.pyä¸­çš„APIé…ç½®
client = OpenAI(
    base_url='https://api-inference.modelscope.cn/v1',
    api_key='ms-81c1f87a-fa0a-4edc-a4a5-4bc7ba3cbbba',
)

@app.route('/')
def index():
    # å°†HTMLå†…å®¹åˆ†è§£ä¸ºå¤šä¸ªå­—ç¬¦ä¸²ç‰‡æ®µï¼Œé¿å…è½¬ä¹‰é—®é¢˜
    html_head = '''<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>å¯¹è¯</title>
    <style>
      body { margin: 0; padding: 20px; font-family: Arial; background-color: white; }
      #messages { height: 400px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; background-color: white; }
      .user, .assistant { margin: 5px 0; padding: 8px; border-radius: 5px; }
      .user { text-align: right; background: #e3f2fd; }
      .assistant { background: #f5f5f5; }
      .system { text-align: center; background: #fff3e0; padding: 5px; margin: 5px 0; font-style: italic; color: #795548; }
      input { width: 75%; padding: 10px; border: 1px solid #ccc; }
      button { padding: 10px 15px; background: #4CAF50; color: white; border: none; cursor: pointer; }
    </style>
</head>
<body>'''
    
    html_body = '''
    <div id="messages"></div>
    <input type="text" id="input" placeholder="å…«æˆ’ï¼Œæœ‰ä½•è¯è¦è¯´ï¼Ÿ">
    <button id="sendBtn" onclick="sendMessage()">å‘é€</button>

    <script>
      function sendMessage() {
        var msg = document.getElementById('input').value.trim();
        if (!msg) return;
        
        var btn = document.getElementById('sendBtn');
        btn.disabled = true;
        btn.textContent = 'å‘é€ä¸­...';
        
        addMessage(msg, 'user');
        document.getElementById('input').value = '';
        
        // ä¸ºåŠ©æ‰‹æ¶ˆæ¯å‡†å¤‡ä¸€ä¸ªå®¹å™¨
        var assistantDiv = document.createElement('div');
        assistantDiv.className = 'assistant';
        document.getElementById('messages').appendChild(assistantDiv);
        document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
        
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/api/chat', true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        
        // å¤„ç†æµå¼å“åº”
        xhr.onreadystatechange = function() {
          if (xhr.readyState == 3) {
            // è·å–å½“å‰å“åº”æ–‡æœ¬
            var chunk = xhr.responseText;
            // åˆ†å‰²æˆå¤šè¡Œ
            var lines = chunk.split('\\n');
            
            // æ¸…ç©ºç°æœ‰å†…å®¹ï¼Œå› ä¸ºresponseTextåŒ…å«æ‰€æœ‰å·²æ¥æ”¶çš„æ•°æ®
            assistantDiv.textContent = '';
            
            for (var i = 0; i < lines.length; i++) {
              var line = lines[i].trim();
              if (line.startsWith('data: ')) {
                try {
                  var dataStr = line.substring(6);
                  if (dataStr) {
                    var data = JSON.parse(dataStr);
                    if (data.content) {
                      // æ·»åŠ å†…å®¹
                      assistantDiv.textContent += data.content;
                      document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
                    }
                    if (data.done) {
                      // å®Œæˆå“åº”
                      btn.disabled = false;
                      btn.textContent = 'å‘é€';
                    }
                    if (data.error) {
                      // å¤„ç†é”™è¯¯
                      assistantDiv.textContent = 'é”™è¯¯: ' + data.error;
                      btn.disabled = false;
                      btn.textContent = 'å‘é€';
                    }
                  }
                } catch (e) {
                  console.error('è§£æé”™è¯¯:', e);
                }
              }
            }
          } else if (xhr.readyState == 4) {
            // è¯·æ±‚å®Œæˆ
            btn.disabled = false;
            btn.textContent = 'å‘é€';
          }
        };
        
        xhr.send(JSON.stringify({message: msg}));
      }
      
      function addMessage(content, type) {
        var div = document.createElement('div');
        div.className = type;
        div.textContent = content;
        document.getElementById('messages').appendChild(div);
        document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
      }
      
      // ç›‘å¬å›è½¦äº‹ä»¶
      document.getElementById('input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          sendMessage();
        }
      });
    </script>
</body>
</html>'''
    
    # åˆå¹¶æ‰€æœ‰HTMLç‰‡æ®µ
    return html_head + html_body

@app.route('/api/chat', methods=['POST'])
def chat():
    data = request.get_json()
    user_message = data.get('message', '')
    
    # æ„å»ºæ¶ˆæ¯åˆ—è¡¨ï¼Œä½¿ç”¨llm.pyä¸­çš„ç³»ç»Ÿæ¶ˆæ¯
    messages = [
        {"role": "system", "content": "ä½ æ˜¯å­™æ‚Ÿç©ºï¼Œæˆ‘æ˜¯çŒªå…«æˆ’"},
        {"role": "user", "content": user_message}
    ]
    
    # åœ¨æ§åˆ¶å°è¾“å‡ºæ¶ˆæ¯
    show_messages(messages)
    
    def generate():
        try:
            response = client.chat.completions.create(
                model='Qwen/Qwen3-Next-80B-A3B-Instruct',
                messages=messages,
                stream=True
            )
            
            for chunk in response:
                if chunk.choices[0].delta.content:
                    content = chunk.choices[0].delta.content
                    # åœ¨æ§åˆ¶å°è¾“å‡ºå“åº”å†…å®¹
                    print(content, end='', flush=True)
                    yield "data: " + json.dumps({"content": content}) + "\n\n"
            
            print()  # è¾“å‡ºä¸€ä¸ªæ¢è¡Œç¬¦
            yield "data: " + json.dumps({"done": True}) + "\n\n"
            
        except Exception as e:
            print("OpenAI API Error:", str(e))
            yield "data: " + json.dumps({"error": str(e)}) + "\n\n"
    
    return Response(generate(), mimetype='text/plain')

if __name__ == '__main__':
    app.run(debug=True, host='0.0.0.0', port=8080)
```

### è§’è‰²å†æ€»ç»“

- å°è¯•è¿è¡Œ

```
python3 -m http.server 8000 &
firefox localhost
```

- åå°æ•°æ®

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/3584/labs/4266989/uid1190679-20251012-1760280878163) 

- æ‚Ÿç©ºå…«æˆ’çš„äººè®¾ä¸å‡ºç°åœ¨å¯¹è¯ä¸­
	- ä½†æ˜¯ å¯¹å¤§æ¨¡å‹çš„å›ç­”ä¼šæœ‰å½±å“

|è§’è‰²|	æ ¸å¿ƒå®šä½	|ä½œç”¨ä¸ç‰¹ç‚¹|	å…¸å‹ä½¿ç”¨åœºæ™¯ä¸¾ä¾‹|	
|---|---|---|---|
|system |	ç³»ç»Ÿ | 1. æå‰è®¾å®šæ¨¡å‹  <br/>2. ä¸ç›´æ¥å‚ä¸å¯¹è¯ï¼Œç”¨æˆ·çœ‹ä¸åˆ°<br/>3. å½±å“æ•´ä¸ªå¯¹è¯çš„å›ç­”é£æ ¼å’Œæ–¹å‘	|ä½ æ˜¯å­™æ‚Ÿç©º<br/>æˆ‘æ˜¯çŒªå…«æˆ’|
|user|	å¯¹è¯éœ€æ±‚å‘èµ·è€…|1. ç”¨æˆ·çš„é—®é¢˜<br/>2. ç›´æ¥è§¦å‘æ¨¡å‹<br/>3. æ¥ç”Ÿæˆå›åº”çš„æ ¸å¿ƒ<br/>|	ä½ å¯¹å–ç»æ€ä¹ˆçœ‹ï¼Ÿ	|

- å¯ä»¥æŠŠæ‚Ÿç©ºã€å…«æˆ’çš„åå­—å†™æ¸…æ¥šå—ï¼Ÿ

### å†™æ¸…æ¥š

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/3584/labs/4266989/uid1190679-20251012-1760281169322) 

```python
from flask import Flask, request, Response
from flask_cors import CORS
from openai import OpenAI
import json

app = Flask(__name__)
CORS(app)

# ä»llm.pyé›†æˆçš„show_messageså‡½æ•°
def show_messages(messages):
    print("==========æ¶ˆæ¯å¼€å§‹==============")
    counter = 1
    for message in messages:
        print("\033[4" + str(counter) + "m", end="")
        print(message, end="")
        print("\33[0m")
        counter = counter + 1
        if counter == 7:
            counter = 1
    print("==========æ¶ˆæ¯ç»“æŸ==============")

# ä½¿ç”¨llm.pyä¸­çš„APIé…ç½®
client = OpenAI(
    base_url='https://api-inference.modelscope.cn/v1',
    api_key='ms-81c1f87a-fa0a-4edc-a4a5-4bc7ba3cbbba',
)

@app.route('/')
def index():
    # å°†HTMLå†…å®¹åˆ†è§£ä¸ºå¤šä¸ªå­—ç¬¦ä¸²ç‰‡æ®µï¼Œé¿å…è½¬ä¹‰é—®é¢˜
    html_head = '''<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>å¯¹è¯</title>
    <style>
      body { margin: 0; padding: 20px; font-family: Arial; background-color: white; }
      #messages { height: 400px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; background-color: white; }
      .user, .assistant, .system { margin: 10px 0; }
      .message-header { font-size: 12px; font-weight: bold; margin-bottom: 2px; }
      .message-content { padding: 8px; border-radius: 5px; word-wrap: break-word; }
      .user .message-header { text-align: right; color: #1976D2; }
      .assistant .message-header { color: #4CAF50; }
      .user .message-content { text-align: right; background: #e3f2fd; }
      .assistant .message-content { background: #f5f5f5; }
      .system { text-align: center; background: #fff3e0; padding: 5px; margin: 5px 0; font-style: italic; color: #795548; }
      input { width: 75%; padding: 10px; border: 1px solid #ccc; }
      button { padding: 10px 15px; background: #4CAF50; color: white; border: none; cursor: pointer; }
    </style>
</head>
<body>'''
    
    html_body = '''
    <div id="messages"></div>
    <input type="text" id="input" placeholder="å…«æˆ’ï¼Œæœ‰ä½•è¯è¦è¯´ï¼Ÿ">
    <button id="sendBtn" onclick="sendMessage()">å‘é€</button>

    <script>
      function sendMessage() {
        var msg = document.getElementById('input').value.trim();
        if (!msg) return;
        
        var btn = document.getElementById('sendBtn');
        btn.disabled = true;
        btn.textContent = 'å‘é€ä¸­...';
        
        addMessage(msg, 'user');
        document.getElementById('input').value = '';
        
        // ä¸ºåŠ©æ‰‹æ¶ˆæ¯å‡†å¤‡ä¸€ä¸ªå®¹å™¨
        var assistantContainer = document.createElement('div');
        assistantContainer.className = 'assistant';
        
        var assistantHeader = document.createElement('div');
        assistantHeader.className = 'message-header';
        assistantHeader.textContent = 'æ‚Ÿç©º';
        
        var assistantMessage = document.createElement('div');
        assistantMessage.className = 'message-content';
        
        assistantContainer.appendChild(assistantHeader);
        assistantContainer.appendChild(assistantMessage);
        
        document.getElementById('messages').appendChild(assistantContainer);
        document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
        
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/api/chat', true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        
        // å¤„ç†æµå¼å“åº”
        xhr.onreadystatechange = function() {
          if (xhr.readyState == 3) {
            // è·å–å½“å‰å“åº”æ–‡æœ¬
            var chunk = xhr.responseText;
            // åˆ†å‰²æˆå¤šè¡Œ
            var lines = chunk.split('\\n');
            
            // æ¸…ç©ºç°æœ‰å†…å®¹ï¼Œå› ä¸ºresponseTextåŒ…å«æ‰€æœ‰å·²æ¥æ”¶çš„æ•°æ®
            assistantMessage.textContent = '';
            
            for (var i = 0; i < lines.length; i++) {
              var line = lines[i].trim();
              if (line.startsWith('data: ')) {
                try {
                  var dataStr = line.substring(6);
                  if (dataStr) {
                    var data = JSON.parse(dataStr);
                    if (data.content) {
                    // æ·»åŠ å†…å®¹
                    assistantMessage.textContent += data.content;
                    document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
                  }
                    if (data.done) {
                      // å®Œæˆå“åº”
                      btn.disabled = false;
                      btn.textContent = 'å‘é€';
                    }
                    if (data.error) {
                    // å¤„ç†é”™è¯¯
                    assistantMessage.textContent = 'é”™è¯¯: ' + data.error;
                    btn.disabled = false;
                    btn.textContent = 'å‘é€';
                  }
                  }
                } catch (e) {
                  console.error('è§£æé”™è¯¯:', e);
                }
              }
            }
          } else if (xhr.readyState == 4) {
            // è¯·æ±‚å®Œæˆ
            btn.disabled = false;
            btn.textContent = 'å‘é€';
          }
        };
        
        xhr.send(JSON.stringify({message: msg}));
      }
      
      function addMessage(content, type) {
        var container = document.createElement('div');
        container.className = type;
        
        var header = document.createElement('div');
        header.className = 'message-header';
        header.textContent = type === 'user' ? 'å…«æˆ’' : type === 'assistant' ? 'æ‚Ÿç©º' : 'ç³»ç»Ÿ';
        
        var message = document.createElement('div');
        message.className = 'message-content';
        message.textContent = content;
        
        container.appendChild(header);
        container.appendChild(message);
        
        document.getElementById('messages').appendChild(container);
        document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
      }
      
      // ç›‘å¬å›è½¦äº‹ä»¶
      document.getElementById('input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          sendMessage();
        }
      });
    </script>
</body>
</html>'''
    
    # åˆå¹¶æ‰€æœ‰HTMLç‰‡æ®µ
    return html_head + html_body

@app.route('/api/chat', methods=['POST'])
def chat():
    data = request.get_json()
    user_message = data.get('message', '')
    
    # æ„å»ºæ¶ˆæ¯åˆ—è¡¨ï¼Œä½¿ç”¨llm.pyä¸­çš„ç³»ç»Ÿæ¶ˆæ¯
    messages = [
        {"role": "system", "content": "ä½ æ˜¯å­™æ‚Ÿç©ºï¼Œæˆ‘æ˜¯çŒªå…«æˆ’"},
        {"role": "user", "content": user_message}
    ]
    
    # åœ¨æ§åˆ¶å°è¾“å‡ºæ¶ˆæ¯
    show_messages(messages)
    
    def generate():
        try:
            response = client.chat.completions.create(
                model='Qwen/Qwen3-Next-80B-A3B-Instruct',
                messages=messages,
                stream=True
            )
            
            for chunk in response:
                if chunk.choices[0].delta.content:
                    content = chunk.choices[0].delta.content
                    # åœ¨æ§åˆ¶å°è¾“å‡ºå“åº”å†…å®¹
                    print(content, end='', flush=True)
                    yield "data: " + json.dumps({"content": content}) + "\n\n"
            
            print()  # è¾“å‡ºä¸€ä¸ªæ¢è¡Œç¬¦
            yield "data: " + json.dumps({"done": True}) + "\n\n"
            
        except Exception as e:
            print("OpenAI API Error:", str(e))
            yield "data: " + json.dumps({"error": str(e)}) + "\n\n"
    
    return Response(generate(), mimetype='text/plain')

if __name__ == '__main__':
    app.run(debug=True, host='0.0.0.0', port=8080)
```

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/3584/labs/4245525/uid1190679-20250920-1758376503444) 

- å¯ä»¥è¿ç»­å‘é—®å—ï¼Ÿ

### æŒç»­å‘é—®

- è¿™ä¸ªæ‚Ÿç©º æ²¡æœ‰è®°å¿†
	- æ¯æ¬¡éƒ½æ˜¯æ–°çš„å¯¹è¯ 

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/3584/labs/4262375/uid1190679-20251001-1759288166209) 

- çº¯åç«¯ å¯ä»¥æœ‰è®°å¿†å—ï¼Ÿ

### åŸå§‹ä»£ç 

```
from openai import OpenAI

client = OpenAI(
    base_url='https://api-inference.modelscope.cn/v1',    api_key='ms-b0ae5a32-3e85-44d7-b20f-ba2782189024', # ModelScope
)

response = client.chat.completions.create(
    model='Qwen/Qwen3-Next-80B-A3B-Instruct', # ModelScope Model-Id
    messages=[
        {
            'role': 'system',
            'content': 'You are a helpful assistant.'
        },
        {
            'role': 'user',
            'content': 'ä½ å¥½'
        }
    ],
    stream=True
)

for chunk in response:
    print(chunk.choices[0].delta.content, end='', flush=True)

```

- ä¿®æ”¹ è¯·æ±‚é¡¹

```
from openai import OpenAI

client = OpenAI(
    base_url='https://api-inference.modelscope.cn/v1',    api_key='ms-b0ae5a32-3e85-44d7-b20f-ba2782189024', # ModelScope
)

response = client.chat.completions.create(
    model='Qwen/Qwen3-Next-80B-A3B-Instruct', # ModelScope Model-Id
    messages=[
        {
            'role': 'system',
            'content': 'ä½ æ˜¯å­™æ‚Ÿç©ºï¼Œæˆ‘æ˜¯çŒªå…«æˆ’ã€‚è¯·ç”¨å­™æ‚Ÿç©ºçš„è¯­æ°”ä¸æˆ‘å¯¹è¯ã€‚'
        },
        {
            'role': 'user',
            'content': input("å…«æˆ’é“:")
        }
    ],
    stream=True
)

print("æ‚Ÿç©ºé“:",end="")
for chunk in response:
    print(chunk.choices[0].delta.content, end='', flush=True)

```

- æ•ˆæœ

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/3584/labs/4262375/uid1190679-20251001-1759288508696) 

- è®©å¯¹è¯å¾ªç¯èµ·æ¥

### å¾ªç¯

```
from openai import OpenAI

client = OpenAI(
    base_url='https://api-inference.modelscope.cn/v1',    api_key='ms-b0ae5a32-3e85-44d7-b20f-ba2782189024', # ModelScope
)

while True:
    response = client.chat.completions.create(
        model='Qwen/Qwen3-Next-80B-A3B-Instruct', # ModelScope Model-Id
        messages=[
            {
                'role': 'system',
                'content': 'ä½ æ˜¯å­™æ‚Ÿç©ºï¼Œæˆ‘æ˜¯çŒªå…«æˆ’ã€‚è¯·ç”¨å­™æ‚Ÿç©ºçš„è¯­æ°”ä¸æˆ‘å¯¹è¯ã€‚'
            },
            {
                'role': 'user',
                'content': input("å…«æˆ’é“:")
            }
        ],
        stream=True
    )

    print("\næ‚Ÿç©ºé“:",end="")
    for chunk in response:
        print(chunk.choices[0].delta.content, end='', flush=True)

	print("\n")
```

### æ•ˆæœ

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/3584/labs/4266989/uid1190679-20251012-1760281422517) 

- å¾ªç¯èµ·æ¥äº†
	- ä½†æ¯æ¬¡å¯¹è¯éƒ½æ˜¯æ–°çš„


![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/3584/labs/4266989/uid1190679-20251012-1760281468091) 

- æ‚Ÿç©ºæ²¡æœ‰è®°å¿†

### æ€»ç»“

- è¿™æ¬¡ å¯ä»¥åœ¨çº¯å‰ç«¯ `ç½‘é¡µé‡Œ`
	- ç›´æ¥ å’Œ å¤§æ¨¡å‹å¯¹è¯ äº†
- ä½†æ˜¯ å¯¹è¯ä¸­å‘ç° 
	- ä¸è®ºå‰ç«¯ è¿˜æ˜¯ åç«¯
	- å¤§æ¨¡å‹éƒ½ `æ²¡æœ‰`è®°å¿†

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/3584/labs/4245525/uid1190679-20250920-1758377200831) 

- æ€ä¹ˆ è®©å¤§æ¨¡å‹ `æœ‰è®°å¿†` å‘¢ï¼ŸğŸ¤”
- ä¸‹æ¬¡å†è¯´ğŸ‘‹