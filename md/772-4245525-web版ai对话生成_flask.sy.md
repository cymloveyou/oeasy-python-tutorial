---
show: step
version: 1.0
enable_checker: true
---

# æ–‡ç”Ÿå›¾æ¨¡å‹è°ƒç”¨

## æ€»ç»“
- ä¸Šæ¬¡ æˆ‘ä»¬äº†è§£äº†
	- æ™ºèƒ½ä½“çš„æ¨ç†èƒ½åŠ›(reasoning)

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/3584/labs/4262510/uid1190679-20251012-1760234899626) 

- å¯ä»¥æŠŠæ™ºèƒ½ä½“æ”¾åˆ°æµè§ˆå™¨é‡Œé¢å—ï¼ŸğŸ¤”

### æœ€åˆçš„é—®é¢˜



- å¯ä»¥æŠŠè¿™ä¸ªä¿®æ”¹ä¸ºç½‘é¡µåº”ç”¨å—ï¼Ÿ

### å°è¯•

```
from openai import OpenAI

client = OpenAI(
    base_url='https://api-inference.modelscope.cn/v1', api_key='ms-0b109ff5-6dc9-452b-be7d-1171078fb624',
)

response = client.chat.completions.create(
    model='Qwen/Qwen3-Next-80B-A3B-Instruct', # ModelScope Model-Id
    messages=[
        {
            'role': 'system',
            'content': 'You are a helpful assistant.'
        },
        {
            'role': 'user',
            'content': 'ä½ å¥½'
        }
    ],
    stream=True
)

for chunk in response:
    print(chunk.choices[0].delta.content, end='', flush=True)
```

- å°†ç»ˆç«¯åº”ç”¨è½¬åŒ–ä¸º
	- webåº”ç”¨

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/3584/labs/4245525/uid1190679-20250920-1758362423893) 

### æç¤ºè¯prompt

- æ ¸å¿ƒæç¤º
	- Flask
	- RESTful APIæ¥å£

```
è¯·å°†ç°æœ‰çš„å‘½ä»¤è¡ŒAIå¯¹è¯è„šæœ¬è½¬æ¢ä¸ºå®Œæ•´çš„Webåº”ç”¨ï¼ŒåŒ…å«ä»¥ä¸‹è¦æ±‚ï¼š

1. **åç«¯æ¶æ„**ï¼š
   - ä½¿ç”¨Flaskæ¡†æ¶åˆ›å»ºWebæœåŠ¡å™¨
   - ä¿æŒç°æœ‰çš„OpenAIå®¢æˆ·ç«¯é…ç½®ï¼ˆModelScope APIï¼‰
   - å®ç°RESTful APIæ¥å£ `/api/chat`
   - æ”¯æŒæµå¼å“åº”ï¼ˆServer-Sent Eventsï¼‰
   - æ·»åŠ CORSæ”¯æŒä»¥å…è®¸å‰ç«¯è®¿é—®

2. **å‰ç«¯ç•Œé¢**ï¼š
   - åˆ›å»ºç®€æ´çš„HTMLé¡µé¢ï¼ŒåŒ…å«æ¶ˆæ¯æ˜¾ç¤ºåŒºåŸŸå’Œè¾“å…¥æ¡†
   - å®ç°å®æ—¶æµå¼å¯¹è¯æ˜¾ç¤º
   - æ”¯æŒç”¨æˆ·è¾“å…¥å’ŒAIå›å¤çš„åŒºåˆ†æ˜¾ç¤º
   - æ·»åŠ åŸºç¡€çš„CSSæ ·å¼ï¼ˆé»‘ç™½é…è‰²ï¼‰

3. **æ ¸å¿ƒåŠŸèƒ½**ï¼š
   - ä¿æŒåŸæœ‰çš„AIæ¨¡å‹è°ƒç”¨é€»è¾‘
   - å®ç°å‰åç«¯é€šä¿¡
   - æ”¯æŒå®æ—¶æµå¼å“åº”æ˜¾ç¤º
   - ç¡®ä¿ç”¨æˆ·ä½“éªŒæµç•…
```

### åº”ç”¨ä»£ç 

- app.py

```
from flask import Flask, request, send_file, Response
from flask_cors import CORS
from openai import OpenAI
import json

app = Flask(__name__)
CORS(app)

client = OpenAI(
    base_url='https://api-inference.modelscope.cn/v1', 
    api_key='ms-0b109ff5-6dc9-452b-be7d-1171078fb624',
)

@app.route('/')
def index():
    return send_file('index.html')

@app.route('/api/chat', methods=['POST'])
def chat():
    data = request.get_json()
    user_message = data.get('message', '')
    
    def generate():
        try:
            response = client.chat.completions.create(
                model='Qwen/Qwen3-Next-80B-A3B-Instruct',
                messages=[
                    {"role": "system", "content": "You are a helpful assistant."},
                    {"role": "user", "content": user_message}
                ],
                stream=True
            )
            
            for chunk in response:
                if chunk.choices[0].delta.content:
                    content = chunk.choices[0].delta.content
                    yield f"data: {json.dumps({'content': content})}\n\n"
            
            yield f"data: {json.dumps({'done': True})}\n\n"
            
        except Exception as e:
            # è¾“å‡ºé”™è¯¯ä¿¡æ¯åˆ°æ§åˆ¶å°ï¼Œæ–¹ä¾¿è°ƒè¯•
            print(f"OpenAI API Error: {str(e)}")
            yield f"data: {json.dumps({'error': str(e)})}\n\n"
    
    return Response(generate(), mimetype='text/plain')

if __name__ == '__main__':
    app.run(debug=True, host='0.0.0.0', port=8080)
```

### é¦–é¡µä»£ç 

- index.html

```
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>å¯¹è¯</title>
    <style>
        body { margin: 0; padding: 20px; font-family: Arial; }
        #messages { height: 400px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
        .user, .assistant { margin: 5px 0; padding: 8px; border-radius: 5px; }
        .user { text-align: right; background: #e3f2fd; }
        .assistant { background: #f5f5f5; }
        input { width: 75%; padding: 10px; border: 1px solid #ccc; }
        button { padding: 10px 15px; background: #333; color: white; border: none; cursor: pointer; }
    </style>
</head>
<body>
    <div id="messages"></div>
    <input type="text" id="input" placeholder="è¾“å…¥æ¶ˆæ¯...">
    <button onclick="send()">å‘é€</button>

    <script>
        async function send() {
            const input = document.getElementById('input');
            const button = document.querySelector('button');
            const msg = input.value.trim();
            if (!msg) return;
            
            button.disabled = true;
            button.textContent = 'å‘é€ä¸­...';
            
            add(msg, 'user');
            input.value = '';
            
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({message: msg})
                });
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let content = '', assistantDiv;
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const lines = decoder.decode(value, { stream: true }).split('\n');
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.substring(6));
                                if (data.content) {
                                    content += data.content;
                                    if (!assistantDiv) {
                                        assistantDiv = document.createElement('div');
                                        assistantDiv.className = 'assistant';
                                        document.getElementById('messages').appendChild(assistantDiv);
                                    }
                                    assistantDiv.textContent = content;
                                    document.getElementById('messages').scrollTop = 999999;
                                } else if (data.error) {
                                    if (!assistantDiv) {
                                        assistantDiv = document.createElement('div');
                                        assistantDiv.className = 'assistant';
                                        document.getElementById('messages').appendChild(assistantDiv);
                                    }
                                    assistantDiv.textContent = 'é”™è¯¯: ' + data.error;
                                }
                            } catch (e) {}
                        }
                    }
                }
            } catch (error) {
                add('é”™è¯¯: ' + (error.message || 'æœªçŸ¥é”™è¯¯'), 'assistant');
            } finally {
                button.disabled = false;
                button.textContent = 'å‘é€';
                input.focus();
            }
        }
        
        function add(content, type) {
            const div = document.createElement('div');
            div.className = type;
            div.textContent = content;
            document.getElementById('messages').appendChild(div);
            document.getElementById('messages').scrollTop = 999999;
        }
    </script>
</body>
</html>
```

### æµè§ˆç½‘é¡µ

### æ€»ç»“

- è¿™æ¬¡ å¯ä»¥åœ¨ `ç½‘é¡µé‡Œ`
	- å’Œ å¤§æ¨¡å‹å¯¹è¯äº†
- ä½†æ˜¯ä½¿ç”¨ä¸¤ä¸ªæ–‡ä»¶
	1. app.py
	2. index.html

![å›¾ç‰‡æè¿°](https://doc.shiyanlou.com/courses/3584/labs/4245525/uid1190679-20251012-1760243139053) 

- å¯ä»¥æŠŠä»–ä¿©`æ•´åˆ`èµ·æ¥å—ï¼ŸğŸ¤”
- ä¸‹æ¬¡å†è¯´ğŸ‘‹